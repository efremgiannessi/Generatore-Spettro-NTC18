<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Spettro NTC18</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (CDNjs) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Prop-Types (Necessario per Recharts) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts (CDNjs - Versione stabile per browser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
    
    <!-- Babel (Compilatore JSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        /* Custom scrollbar per la dark mode */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
        body {
            background-color: #020617; /* Slate 950 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- SETUP GLOBALE ---
        const { useState, useMemo, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts;

        // --- ICONE SVG INTERNE (Rimossa dipendenza esterna per stabilità) ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round"
                className={className}
            >
                {children}
            </svg>
        );

        const MapPin = (props) => (
            <IconWrapper {...props}>
                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" />
            </IconWrapper>
        );
        const Settings = (props) => (
            <IconWrapper {...props}>
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" />
            </IconWrapper>
        );
        const Activity = (props) => (
            <IconWrapper {...props}>
                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
            </IconWrapper>
        );
        const FileText = (props) => (
            <IconWrapper {...props}>
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><line x1="10" x2="8" y1="9" y2="9" />
            </IconWrapper>
        );
        const Info = (props) => (
            <IconWrapper {...props}>
                <circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" />
            </IconWrapper>
        );
        const AlertTriangle = (props) => (
            <IconWrapper {...props}>
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><path d="M12 9v4" /><path d="M12 17h.01" />
            </IconWrapper>
        );
        const Edit3 = (props) => (
            <IconWrapper {...props}>
                <path d="M12 20h9" /><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z" />
            </IconWrapper>
        );
        const Database = (props) => (
            <IconWrapper {...props}>
                <ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
            </IconWrapper>
        );


        // --- COSTANTI NTC 2018 ---

        const USE_CLASSES = {
            'I': 0.7,
            'II': 1.0,
            'III': 1.5,
            'IV': 2.0
        };

        const P_VR = {
            'SLO': 0.81, 
            'SLD': 0.63, 
            'SLV': 0.10, 
            'SLC': 0.05  
        };

        const SOIL_CATEGORIES = [
            { value: 'A', label: 'A - Ammassi rocciosi o terreni molto rigidi', desc: 'Vs,30 > 800 m/s' },
            { value: 'B', label: 'B - Rocce tenere o depositi grossolani', desc: '360 < Vs,30 < 800 m/s' },
            { value: 'C', label: 'C - Depositi grana grossa media densità', desc: '180 < Vs,30 < 360 m/s' },
            { value: 'D', label: 'D - Depositi coesivi/sciolti scarsa rigidezza', desc: 'Vs,30 < 180 m/s' },
            { value: 'E', label: 'E - Terreni con caratteristiche alluvionali', desc: 'Simili a C o D su substrato rigido' }
        ];

        const TOPO_CATEGORIES = [
            { value: 'T1', label: 'T1 - Superficie pianeggiante', st: 1.0 },
            { value: 'T2', label: 'T2 - Pendii (i > 15°)', st: 1.2 },
            { value: 'T3', label: 'T3 - Rilievi con larghezza in cresta ridotta', st: 1.2 },
            { value: 'T4', label: 'T4 - Rilievi con cresta accentuata', st: 1.4 },
        ];

        const CITIES_MOCK_DATA = {
            'Agrigento': { ag: 0.178, F0: 2.38, TcStar: 0.32 },
            'Alessandria': { ag: 0.098, F0: 2.50, TcStar: 0.28 },
            'Ancona': { ag: 0.205, F0: 2.45, TcStar: 0.33 },
            'Aosta': { ag: 0.065, F0: 2.55, TcStar: 0.25 },
            'Arezzo': { ag: 0.185, F0: 2.40, TcStar: 0.31 },
            'Ascoli Piceno': { ag: 0.235, F0: 2.42, TcStar: 0.34 },
            'Asti': { ag: 0.085, F0: 2.52, TcStar: 0.27 },
            'Avellino': { ag: 0.265, F0: 2.36, TcStar: 0.36 },
            'Bari': { ag: 0.075, F0: 2.55, TcStar: 0.28 },
            'Barletta': { ag: 0.085, F0: 2.50, TcStar: 0.30 },
            'Belluno': { ag: 0.210, F0: 2.44, TcStar: 0.30 },
            'Benevento': { ag: 0.275, F0: 2.35, TcStar: 0.36 },
            'Bergamo': { ag: 0.105, F0: 2.48, TcStar: 0.29 },
            'Biella': { ag: 0.055, F0: 2.58, TcStar: 0.24 },
            'Bologna': { ag: 0.145, F0: 2.42, TcStar: 0.30 },
            'Bolzano': { ag: 0.060, F0: 2.55, TcStar: 0.26 },
            'Brescia': { ag: 0.165, F0: 2.45, TcStar: 0.30 },
            'Brindisi': { ag: 0.055, F0: 2.58, TcStar: 0.28 },
            'Cagliari': { ag: 0.040, F0: 2.60, TcStar: 0.20 },
            'Caltanissetta': { ag: 0.185, F0: 2.38, TcStar: 0.33 },
            'Campobasso': { ag: 0.245, F0: 2.38, TcStar: 0.35 },
            'Carbonia': { ag: 0.042, F0: 2.60, TcStar: 0.20 },
            'Caserta': { ag: 0.185, F0: 2.40, TcStar: 0.35 },
            'Catania': { ag: 0.215, F0: 2.45, TcStar: 0.31 },
            'Catanzaro': { ag: 0.265, F0: 2.35, TcStar: 0.37 },
            'Chieti': { ag: 0.225, F0: 2.40, TcStar: 0.34 },
            'Como': { ag: 0.085, F0: 2.50, TcStar: 0.27 },
            'Cosenza': { ag: 0.285, F0: 2.34, TcStar: 0.38 },
            'Cremona': { ag: 0.115, F0: 2.46, TcStar: 0.29 },
            'Crotone': { ag: 0.215, F0: 2.40, TcStar: 0.34 },
            'Cuneo': { ag: 0.075, F0: 2.55, TcStar: 0.26 },
            'Enna': { ag: 0.195, F0: 2.38, TcStar: 0.33 },
            'Fermo': { ag: 0.215, F0: 2.44, TcStar: 0.33 },
            'Ferrara': { ag: 0.135, F0: 2.45, TcStar: 0.32 },
            'Firenze': { ag: 0.155, F0: 2.40, TcStar: 0.30 },
            'Foggia': { ag: 0.205, F0: 2.40, TcStar: 0.34 },
            'Forlì': { ag: 0.195, F0: 2.42, TcStar: 0.32 },
            'Frosinone': { ag: 0.245, F0: 2.36, TcStar: 0.35 },
            'Genova': { ag: 0.095, F0: 2.50, TcStar: 0.28 },
            'Gorizia': { ag: 0.165, F0: 2.45, TcStar: 0.30 },
            'Grosseto': { ag: 0.115, F0: 2.48, TcStar: 0.29 },
            'Imperia': { ag: 0.145, F0: 2.45, TcStar: 0.29 },
            'Isernia': { ag: 0.255, F0: 2.38, TcStar: 0.35 },
            'L\'Aquila': { ag: 0.260, F0: 2.39, TcStar: 0.34 },
            'La Spezia': { ag: 0.135, F0: 2.46, TcStar: 0.29 },
            'Latina': { ag: 0.135, F0: 2.45, TcStar: 0.33 },
            'Lecce': { ag: 0.065, F0: 2.55, TcStar: 0.28 },
            'Lecco': { ag: 0.095, F0: 2.50, TcStar: 0.28 },
            'Livorno': { ag: 0.125, F0: 2.45, TcStar: 0.30 },
            'Lodi': { ag: 0.095, F0: 2.50, TcStar: 0.29 },
            'Lucca': { ag: 0.155, F0: 2.42, TcStar: 0.30 },
            'Macerata': { ag: 0.215, F0: 2.42, TcStar: 0.33 },
            'Mantova': { ag: 0.125, F0: 2.45, TcStar: 0.30 },
            'Massa': { ag: 0.165, F0: 2.42, TcStar: 0.30 },
            'Matera': { ag: 0.145, F0: 2.45, TcStar: 0.32 },
            'Messina': { ag: 0.275, F0: 2.35, TcStar: 0.36 },
            'Milano': { ag: 0.050, F0: 2.50, TcStar: 0.28 },
            'Modena': { ag: 0.135, F0: 2.45, TcStar: 0.30 },
            'Monza': { ag: 0.055, F0: 2.50, TcStar: 0.28 },
            'Napoli': { ag: 0.165, F0: 2.35, TcStar: 0.36 },
            'Novara': { ag: 0.065, F0: 2.55, TcStar: 0.26 },
            'Nuoro': { ag: 0.045, F0: 2.60, TcStar: 0.22 },
            'Oristano': { ag: 0.040, F0: 2.60, TcStar: 0.20 },
            'Padova': { ag: 0.105, F0: 2.48, TcStar: 0.30 },
            'Palermo': { ag: 0.175, F0: 2.38, TcStar: 0.32 },
            'Parma': { ag: 0.135, F0: 2.45, TcStar: 0.30 },
            'Pavia': { ag: 0.085, F0: 2.52, TcStar: 0.28 },
            'Perugia': { ag: 0.205, F0: 2.42, TcStar: 0.32 },
            'Pesaro': { ag: 0.185, F0: 2.44, TcStar: 0.32 },
            'Pescara': { ag: 0.185, F0: 2.42, TcStar: 0.33 },
            'Piacenza': { ag: 0.105, F0: 2.48, TcStar: 0.29 },
            'Pisa': { ag: 0.125, F0: 2.46, TcStar: 0.30 },
            'Pistoia': { ag: 0.165, F0: 2.40, TcStar: 0.30 },
            'Pordenone': { ag: 0.185, F0: 2.44, TcStar: 0.30 },
            'Potenza': { ag: 0.255, F0: 2.36, TcStar: 0.35 },
            'Prato': { ag: 0.165, F0: 2.40, TcStar: 0.30 },
            'Ragusa': { ag: 0.225, F0: 2.38, TcStar: 0.32 },
            'Ravenna': { ag: 0.175, F0: 2.44, TcStar: 0.32 },
            'Reggio Calabria': { ag: 0.285, F0: 2.34, TcStar: 0.38 },
            'Reggio Emilia': { ag: 0.135, F0: 2.45, TcStar: 0.30 },
            'Rieti': { ag: 0.255, F0: 2.36, TcStar: 0.34 },
            'Rimini': { ag: 0.195, F0: 2.42, TcStar: 0.32 },
            'Roma': { ag: 0.125, F0: 2.38, TcStar: 0.33 },
            'Rovigo': { ag: 0.105, F0: 2.48, TcStar: 0.31 },
            'Salerno': { ag: 0.205, F0: 2.38, TcStar: 0.36 },
            'Sassari': { ag: 0.040, F0: 2.60, TcStar: 0.20 },
            'Savona': { ag: 0.105, F0: 2.48, TcStar: 0.28 },
            'Siena': { ag: 0.135, F0: 2.42, TcStar: 0.30 },
            'Siracusa': { ag: 0.245, F0: 2.38, TcStar: 0.32 },
            'Sondrio': { ag: 0.065, F0: 2.55, TcStar: 0.25 },
            'Taranto': { ag: 0.065, F0: 2.55, TcStar: 0.28 },
            'Teramo': { ag: 0.225, F0: 2.40, TcStar: 0.33 },
            'Terni': { ag: 0.185, F0: 2.42, TcStar: 0.32 },
            'Torino': { ag: 0.045, F0: 2.55, TcStar: 0.25 },
            'Trapani': { ag: 0.145, F0: 2.40, TcStar: 0.32 },
            'Trento': { ag: 0.105, F0: 2.48, TcStar: 0.28 },
            'Treviso': { ag: 0.175, F0: 2.44, TcStar: 0.30 },
            'Trieste': { ag: 0.095, F0: 2.50, TcStar: 0.28 },
            'Udine': { ag: 0.215, F0: 2.42, TcStar: 0.30 },
            'Varese': { ag: 0.055, F0: 2.55, TcStar: 0.26 },
            'Venezia': { ag: 0.105, F0: 2.48, TcStar: 0.30 },
            'Verbania': { ag: 0.055, F0: 2.55, TcStar: 0.25 },
            'Vercelli': { ag: 0.065, F0: 2.55, TcStar: 0.26 },
            'Verona': { ag: 0.155, F0: 2.45, TcStar: 0.30 },
            'Vibo Valentia': { ag: 0.265, F0: 2.35, TcStar: 0.37 },
            'Vicenza': { ag: 0.145, F0: 2.46, TcStar: 0.30 },
            'Viterbo': { ag: 0.155, F0: 2.40, TcStar: 0.32 },
        };

        const App = () => {
            // --- STATO ---
            const [selectedCity, setSelectedCity] = useState('Roma');
            
            // Parametri Generali
            const [vn, setVn] = useState(50); 
            const [useClass, setUseClass] = useState('II'); 
            const [soilCat, setSoilCat] = useState('B'); 
            const [topoCat, setTopoCat] = useState('T1'); 
            const [qFactor, setQFactor] = useState(1.5); 

            // Modalità Dati
            const [dataMode, setDataMode] = useState('auto'); 
            
            // Dati Manuali
            const [baseParams, setBaseParams] = useState(CITIES_MOCK_DATA['Roma']);
            const [advancedParams, setAdvancedParams] = useState({
                SLO: { ag: 0.05, F0: 2.40, TcStar: 0.28 },
                SLD: { ag: 0.07, F0: 2.40, TcStar: 0.30 },
                SLV: { ag: 0.15, F0: 2.35, TcStar: 0.34 },
                SLC: { ag: 0.19, F0: 2.40, TcStar: 0.35 }
            });

            const [visibleStates, setVisibleStates] = useState({
                SLO: false,
                SLD: false,
                SLV: true,
                SLC: false
            });

            // --- LOGICA DI CALCOLO NTC 2018 ---
            const calculateResults = useMemo(() => {
                const Cu = USE_CLASSES[useClass];
                const Vr = vn * Cu; 

                // Helper Ss (Tab. 3.2.IV)
                const getSs = (cat, ag, f0) => {
                    const fh = f0 * ag; 
                    switch(cat) {
                        case 'A': return 1.00;
                        case 'B': return Math.min(Math.max(1.00, 1.40 - 0.40 * fh), 1.20);
                        case 'C': return Math.min(Math.max(1.00, 1.70 - 0.60 * fh), 1.50);
                        case 'D': return Math.min(Math.max(0.90, 2.40 - 1.50 * fh), 1.80);
                        case 'E': return Math.min(Math.max(1.00, 2.00 - 1.10 * fh), 1.60);
                        default: return 1.00;
                    }
                };

                const getCc = (cat, tcStar) => {
                    const factors = {'A': 1.0, 'B': 1.2, 'C': 1.5, 'D': 1.8, 'E': 1.6};
                    return factors[cat] || 1.0; 
                };

                const St = TOPO_CATEGORIES.find(t => t.value === topoCat)?.st || 1.0;
                const points = 100;
                const maxT = 4.0;
                const limitStatesData = {};

                Object.keys(P_VR).forEach(sl => {
                    if (!visibleStates[sl]) return;

                    const pvr = P_VR[sl];
                    const Tr = -(Vr) / Math.log(1 - pvr);
                    
                    let ag, F0, TcStar;

                    if (dataMode === 'manual_advanced') {
                        ag = advancedParams[sl].ag;
                        F0 = advancedParams[sl].F0;
                        TcStar = advancedParams[sl].TcStar;
                    } else {
                        let scaleFactor = 1.0;
                        if (sl === 'SLO') scaleFactor = 0.42;
                        if (sl === 'SLD') scaleFactor = 0.55;
                        if (sl === 'SLV') scaleFactor = 1.00;
                        if (sl === 'SLC') scaleFactor = 1.35;

                        ag = baseParams.ag * scaleFactor;
                        F0 = baseParams.F0; 
                        TcStar = baseParams.TcStar;
                    }

                    const Ss = getSs(soilCat, ag, F0);
                    const Cc = getCc(soilCat, TcStar);
                    const S = Ss * St;
                    const Tc = Cc * TcStar;
                    const Tb = Tc / 3.0;
                    const Td = 4.0 * ag / 1.0 + 1.6;
                    
                    const q = (sl === 'SLV' || sl === 'SLC') ? qFactor : 1.0; 
                    const eta = Math.sqrt(10 / (5 + 5)); 

                    const curve = [];
                    for (let i = 0; i <= points; i++) {
                        const T = (i / points) * maxT;
                        let Se = 0;
                        let Sd = 0;

                        if (T < Tb) {
                            Se = ag * S * eta * F0 * (T / Tb + 1/ (eta*F0) * (1 - T/Tb));
                        } else if (T <= Tc) {
                            Se = ag * S * eta * F0;
                        } else if (T <= Td) {
                            Se = ag * S * eta * F0 * (Tc / T);
                        } else {
                            Se = ag * S * eta * F0 * (Tc * Td / (T * T));
                        }
                        
                        Sd = Se;
                        if (q > 1 && (sl === 'SLV' || sl === 'SLC')) {
                            if (T < Tb) {
                                Sd = ag * S * (1 + T/Tb * (F0/q - 1));
                            } else if (T <= Tc) {
                                Sd = ag * S * F0 / q;
                            } else if (T <= Td) {
                                Sd = ag * S * F0 / q * (Tc / T);
                            } else {
                                Sd = ag * S * F0 / q * (Tc * Td / (T * T));
                            }
                        }
                        
                        curve.push({ T: parseFloat(T.toFixed(3)), acc: parseFloat(Sd.toFixed(4)) });
                    }
                    
                    limitStatesData[sl] = {
                        data: curve,
                        params: { ag, F0, TcStar, Ss, St, S, Tb, Tc, Td, Tr }
                    };
                });

                const unifiedData = [];
                for (let i = 0; i <= points; i++) {
                    const T = (i / points) * maxT;
                    const pointObj = { T: parseFloat(T.toFixed(3)) };
                    Object.keys(limitStatesData).forEach(sl => {
                        pointObj[sl] = limitStatesData[sl].data[i].acc;
                    });
                    unifiedData.push(pointObj);
                }

                return { unifiedData, limitStatesData, Vr };
            }, [baseParams, advancedParams, soilCat, topoCat, vn, useClass, qFactor, visibleStates, dataMode]);

            const handleCityChange = (e) => {
                const city = e.target.value;
                setSelectedCity(city);
                setBaseParams(CITIES_MOCK_DATA[city]);
                if(dataMode !== 'manual_advanced') setDataMode('auto');
            };

            const updateAdvancedParam = (sl, field, value) => {
                setAdvancedParams(prev => ({
                    ...prev,
                    [sl]: { ...prev[sl], [field]: parseFloat(value) }
                }));
            };

            // --- RENDER ---
            return (
                <div className="min-h-screen bg-slate-950 text-slate-100 font-sans p-4 md:p-8">
                    
                    {/* HEADER */}
                    <div className="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-center border-b border-slate-800 pb-6">
                        <div>
                        <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                            <Activity className="text-blue-500" size={32} />
                            <span className="bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">
                            Generatore Spettro NTC18
                            </span>
                        </h1>
                        <p className="text-slate-400 mt-2">
                            Calcolo spettri di risposta elastici e di progetto (DM 17/01/2018)
                        </p>
                        </div>
                        <div className="mt-4 md:mt-0 flex gap-3">
                            <div className="bg-slate-900 border border-slate-700 text-slate-300 px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2">
                            <Info size={16} />
                            Versione Standalone (Stable)
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        {/* LEFT COLUMN: INPUTS */}
                        <div className="lg:col-span-4 space-y-6">
                        
                        {/* CARD 1: Dati Sismici */}
                        <div className="bg-slate-900 p-6 rounded-xl shadow-lg border border-slate-800">
                            <div className="flex items-center gap-2 mb-5 text-lg font-semibold text-blue-400 border-b border-slate-800 pb-2">
                            <Database size={20} />
                            1. Parametri Sismici (ag, F0, Tc*)
                            </div>
                            
                            <div className="space-y-4">
                            {/* Selezione Modalità Dati */}
                            <div className="flex bg-slate-950 p-1 rounded-lg border border-slate-800 mb-4">
                                <button 
                                onClick={() => setDataMode('auto')}
                                className={`flex-1 py-1.5 px-2 text-xs font-medium rounded-md transition-all ${dataMode === 'auto' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}
                                >
                                Città (Auto)
                                </button>
                                <button 
                                onClick={() => setDataMode('manual_base')}
                                className={`flex-1 py-1.5 px-2 text-xs font-medium rounded-md transition-all ${dataMode === 'manual_base' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}
                                >
                                Manuale (Base)
                                </button>
                                <button 
                                onClick={() => setDataMode('manual_advanced')}
                                className={`flex-1 py-1.5 px-2 text-xs font-medium rounded-md transition-all ${dataMode === 'manual_advanced' ? 'bg-emerald-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}
                                >
                                Dati Reali (Adv)
                                </button>
                            </div>

                            {dataMode === 'auto' && (
                                <div>
                                <label className="block text-sm font-medium text-slate-400 mb-1">Seleziona Capoluogo</label>
                                <select 
                                    value={selectedCity} 
                                    onChange={handleCityChange}
                                    className="w-full p-2.5 bg-slate-950 border border-slate-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 outline-none custom-scrollbar"
                                    style={{maxHeight: '200px'}}
                                >
                                    {Object.keys(CITIES_MOCK_DATA).sort().map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                                <p className="text-xs text-slate-500 mt-2">
                                    Include tutti i capoluoghi di provincia. Per comuni specifici o coordinate esatte, usa la modalità manuale.
                                </p>
                                </div>
                            )}

                            {dataMode === 'manual_base' && (
                                <div className="bg-slate-950 p-4 rounded-lg border border-slate-800">
                                <p className="text-xs text-slate-400 mb-3">Inserisci i parametri per SLV (475 anni). Verranno scalati per gli altri SL.</p>
                                <div className="grid grid-cols-3 gap-3">
                                    <div>
                                    <label className="text-xs text-blue-400 font-mono block mb-1">ag (g)</label>
                                    <input type="number" step="0.001" value={baseParams.ag} onChange={e => setBaseParams({...baseParams, ag: parseFloat(e.target.value)})} className="w-full p-2 bg-slate-900 border border-slate-700 rounded text-white text-center text-sm" />
                                    </div>
                                    <div>
                                    <label className="text-xs text-blue-400 font-mono block mb-1">F0</label>
                                    <input type="number" step="0.01" value={baseParams.F0} onChange={e => setBaseParams({...baseParams, F0: parseFloat(e.target.value)})} className="w-full p-2 bg-slate-900 border border-slate-700 rounded text-white text-center text-sm" />
                                    </div>
                                    <div>
                                    <label className="text-xs text-blue-400 font-mono block mb-1">Tc* (s)</label>
                                    <input type="number" step="0.01" value={baseParams.TcStar} onChange={e => setBaseParams({...baseParams, TcStar: parseFloat(e.target.value)})} className="w-full p-2 bg-slate-900 border border-slate-700 rounded text-white text-center text-sm" />
                                    </div>
                                </div>
                                </div>
                            )}

                            {dataMode === 'manual_advanced' && (
                                <div className="bg-slate-950 p-3 rounded-lg border border-slate-800 space-y-3 max-h-[300px] overflow-y-auto custom-scrollbar">
                                <p className="text-xs text-emerald-400 mb-1 flex items-center gap-1">
                                    <Edit3 size={12}/> Inserisci parametri esatti per ogni SL
                                </p>
                                {Object.keys(advancedParams).map(sl => (
                                    visibleStates[sl] ? (
                                    <div key={sl} className="p-2 border border-slate-800 rounded bg-slate-900">
                                    <div className="text-xs font-bold text-slate-300 mb-1">{sl}</div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <input type="number" placeholder="ag" step="0.01" value={advancedParams[sl].ag} onChange={e => updateAdvancedParam(sl, 'ag', e.target.value)} className="w-full p-1 bg-slate-950 border border-slate-700 rounded text-white text-xs text-center" title="ag" />
                                        <input type="number" placeholder="F0" step="0.01" value={advancedParams[sl].F0} onChange={e => updateAdvancedParam(sl, 'F0', e.target.value)} className="w-full p-1 bg-slate-950 border border-slate-700 rounded text-white text-xs text-center" title="F0" />
                                        <input type="number" placeholder="Tc*" step="0.01" value={advancedParams[sl].TcStar} onChange={e => updateAdvancedParam(sl, 'TcStar', e.target.value)} className="w-full p-1 bg-slate-950 border border-slate-700 rounded text-white text-xs text-center" title="Tc*" />
                                    </div>
                                    </div>
                                    ) : null
                                ))}
                                <p className="text-[10px] text-slate-500 italic">Abilita gli altri stati limite a destra per editarne i valori.</p>
                                </div>
                            )}
                            </div>
                        </div>

                        {/* CARD 2: Opera & Suolo */}
                        <div className="bg-slate-900 p-6 rounded-xl shadow-lg border border-slate-800">
                            <div className="flex items-center gap-2 mb-5 text-lg font-semibold text-blue-400 border-b border-slate-800 pb-2">
                            <Settings size={20} />
                            2. Sito & Struttura
                            </div>

                            <div className="space-y-5">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Vita Nominale (Vn)</label>
                                <div className="relative">
                                    <input 
                                    type="number" 
                                    value={vn} 
                                    onChange={(e) => setVn(parseInt(e.target.value))}
                                    className="w-full p-2.5 bg-slate-950 border border-slate-700 rounded-lg text-white focus:border-blue-500 transition-colors"
                                    />
                                    <span className="absolute right-3 top-2.5 text-slate-500 text-sm">anni</span>
                                </div>
                                </div>
                                <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Classe d'Uso</label>
                                <select 
                                    value={useClass} 
                                    onChange={(e) => setUseClass(e.target.value)}
                                    className="w-full p-2.5 bg-slate-950 border border-slate-700 rounded-lg text-white"
                                >
                                    {Object.keys(USE_CLASSES).map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Categoria Sottosuolo</label>
                                <select 
                                value={soilCat} 
                                onChange={(e) => setSoilCat(e.target.value)}
                                className="w-full p-2.5 bg-slate-950 border border-slate-700 rounded-lg text-white"
                                >
                                {SOIL_CATEGORIES.map(c => <option key={c.value} value={c.value}>{c.label}</option>)}
                                </select>
                                <p className="text-xs text-slate-500 mt-2 italic px-1">{SOIL_CATEGORIES.find(c => c.value === soilCat)?.desc}</p>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Topografia</label>
                                    <select 
                                    value={topoCat} 
                                    onChange={(e) => setTopoCat(e.target.value)}
                                    className="w-full p-2.5 bg-slate-950 border border-slate-700 rounded-lg text-white"
                                    >
                                    {TOPO_CATEGORIES.map(c => <option key={c.value} value={c.value}>{c.label}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Fattore q</label>
                                    <input 
                                    type="number" 
                                    step="0.1"
                                    min="1.0"
                                    value={qFactor} 
                                    onChange={(e) => setQFactor(parseFloat(e.target.value))}
                                    className="w-full p-2.5 bg-slate-950 border border-slate-700 rounded-lg text-white"
                                    />
                                </div>
                            </div>
                            </div>
                        </div>
                        </div>

                        {/* RIGHT COLUMN: CHART & RESULTS */}
                        <div className="lg:col-span-8 space-y-6">
                        
                        {/* CONTROLLI VISUALIZZAZIONE */}
                        <div className="bg-slate-900 p-4 rounded-xl shadow-lg border border-slate-800 flex flex-wrap gap-4 items-center justify-between">
                            <span className="font-semibold text-slate-300">Stati Limite Attivi:</span>
                            <div className="flex gap-4">
                            {Object.keys(visibleStates).map(sl => (
                                <label key={sl} className="flex items-center gap-2 cursor-pointer select-none group">
                                    <div className={`w-5 h-5 rounded flex items-center justify-center border transition-colors ${visibleStates[sl] ? 'bg-blue-600 border-blue-600' : 'border-slate-600 group-hover:border-slate-500'}`}>
                                        {visibleStates[sl] && <span className="text-white text-xs">✓</span>}
                                    </div>
                                    <input 
                                    type="checkbox" 
                                    className="hidden"
                                    checked={visibleStates[sl]} 
                                    onChange={() => setVisibleStates(prev => ({...prev, [sl]: !prev[sl]}))}
                                    />
                                    <span className={`font-mono font-bold transition-colors ${visibleStates[sl] ? 'text-white' : 'text-slate-600'}`}>{sl}</span>
                                </label>
                            ))}
                            </div>
                        </div>

                        {/* CHART AREA */}
                        <div className="bg-slate-900 p-6 rounded-xl shadow-lg border border-slate-800 h-[500px] flex flex-col relative">
                            <h3 className="text-lg font-bold text-slate-200 mb-4 flex justify-between items-center">
                            <span>Spettro Elastico/Progetto</span>
                            <span className="text-sm font-mono text-emerald-400 bg-emerald-900/30 px-2 py-1 rounded">
                                Vr = {calculateResults.Vr} anni
                            </span>
                            </h3>
                            
                            <div className="flex-grow w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <LineChart
                                data={calculateResults.unifiedData}
                                margin={{ top: 10, right: 30, left: 0, bottom: 20 }}
                                >
                                <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                <XAxis 
                                    dataKey="T" 
                                    type="number" 
                                    label={{ value: 'Periodo T [s]', position: 'insideBottomRight', offset: -5, fill: '#94a3b8' }} 
                                    domain={[0, 4]}
                                    tickCount={9}
                                    stroke="#475569"
                                    tick={{ fill: '#94a3b8' }}
                                />
                                <YAxis 
                                    label={{ value: 'Sa/g', angle: -90, position: 'insideLeft', fill: '#94a3b8' }} 
                                    domain={[0, 'auto']}
                                    stroke="#475569"
                                    tick={{ fill: '#94a3b8' }}
                                />
                                <Tooltip 
                                    contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', color: '#f8fafc', borderRadius: '8px' }}
                                    itemStyle={{ fontSize: '14px', fontWeight: 'bold' }}
                                    labelStyle={{ color: '#94a3b8', marginBottom: '4px' }}
                                    labelFormatter={(label) => `T = ${label} s`}
                                />
                                <Legend verticalAlign="top" height={36} iconType="circle"/>
                                
                                {visibleStates.SLO && <Line type="monotone" dataKey="SLO" stroke="#10b981" strokeWidth={2} dot={false} name="SLO" />}
                                {visibleStates.SLD && <Line type="monotone" dataKey="SLD" stroke="#3b82f6" strokeWidth={2} dot={false} name="SLD" />}
                                {visibleStates.SLV && <Line type="monotone" dataKey="SLV" stroke="#ef4444" strokeWidth={3} dot={false} name="SLV" />}
                                {visibleStates.SLC && <Line type="monotone" dataKey="SLC" stroke="#a855f7" strokeWidth={2} strokeDasharray="5 5" dot={false} name="SLC" />}
                                </LineChart>
                            </ResponsiveContainer>
                            </div>
                            {/* Watermark/Grid overlay style */}
                            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-5">
                            <Activity size={200} color="white" />
                            </div>
                        </div>

                        {/* TABELLA DATI CALCOLATI */}
                        <div className="bg-slate-900 p-6 rounded-xl shadow-lg border border-slate-800">
                            <div className="flex items-center gap-2 mb-4 text-lg font-semibold text-blue-400 border-b border-slate-800 pb-2">
                            <FileText size={20} />
                            Risultati di Calcolo
                            </div>

                            <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-slate-800 text-sm">
                                <thead>
                                <tr className="bg-slate-950">
                                    <th className="px-4 py-3 text-left font-medium text-slate-400">SL</th>
                                    <th className="px-4 py-3 text-left font-medium text-slate-400">Tr (anni)</th>
                                    <th className="px-4 py-3 text-left font-medium text-slate-400">ag (g)</th>
                                    <th className="px-4 py-3 text-left font-medium text-slate-400">S (Ss·St)</th>
                                    <th className="px-4 py-3 text-left font-medium text-slate-400">TB (s)</th>
                                    <th className="px-4 py-3 text-left font-medium text-slate-400">TC (s)</th>
                                    <th className="px-4 py-3 text-left font-medium text-slate-400">TD (s)</th>
                                </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-800 text-slate-300">
                                {Object.keys(visibleStates).filter(k => visibleStates[k]).map(sl => {
                                    const p = calculateResults.limitStatesData[sl].params;
                                    return (
                                    <tr key={sl} className="hover:bg-slate-800 transition-colors">
                                        <td className="px-4 py-3 font-bold text-white">{sl}</td>
                                        <td className="px-4 py-3 text-slate-400">{Math.round(p.Tr)}</td>
                                        <td className="px-4 py-3 text-emerald-400 font-mono">{p.ag.toFixed(3)}</td>
                                        <td className="px-4 py-3 text-blue-400 font-mono">{p.S.toFixed(3)}</td>
                                        <td className="px-4 py-3">{p.Tb.toFixed(3)}</td>
                                        <td className="px-4 py-3">{p.Tc.toFixed(3)}</td>
                                        <td className="px-4 py-3">{p.Td.toFixed(3)}</td>
                                    </tr>
                                    );
                                })}
                                </tbody>
                            </table>
                            </div>
                            
                            <div className="mt-4 flex gap-3 text-xs text-slate-400 bg-slate-950 p-4 rounded border border-slate-800">
                            <AlertTriangle size={16} className="text-amber-500 flex-shrink-0" />
                            <p>
                                {dataMode === 'manual_advanced' 
                                ? "Stai utilizzando parametri inseriti manualmente per ogni Stato Limite. Verifica la coerenza con il periodo di ritorno Tr calcolato."
                                : "I valori di ag sono scalati statisticamente dal valore base (SLV). Per progetti esecutivi, passa alla modalità 'Dati Reali (Adv)' ed inserisci i valori esatti da reticolo."}
                            </p>
                            </div>
                        </div>

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
